"use strict";const{ipcMain:$,dialog:L,app:w}=require("electron"),a=require("fs"),v=require("path"),q=require("archiver"),{spawn:I}=require("child_process");async function D(r){return new Promise((s,b)=>{const g=L.showSaveDialogSync({defaultPath:"recordings.zip",filters:[{name:"ZIP Files",extensions:["zip"]}]});if(g){const y=a.createWriteStream(g),l=q("zip");let i=[];l.pipe(y);for(const P of r){const{name:t,buffer:F}=P,d=v.join(w.getPath("downloads"),`${t}.webm`);a.writeFileSync(d,Buffer.from(F));const u=v.join(w.getPath("downloads"),`${t}.flv`),p=I("ffmpeg",["-i",d,"-c:v","copy","-c:a","aac","-ar",44100,u]);p.on("error",o=>{console.error("Error converting video:",o)}),p.stderr.on("data",o=>{console.error(`ffmpeg stderr: ${o}`)}),p.on("close",async o=>{o===0?(console.log(`Video ${t} converted to FLV successfully.`),l.append(a.createReadStream(u),{name:`${t}.flv`}),i.push({flvFilePath:u,webmFilePath:d}),i.length&&i.length===r.length&&(await l.finalize(),i.map(h=>{a.unlinkSync(h.webmFilePath),a.unlinkSync(h.flvFilePath)}),s(!0))):(b(!1),console.error(`Video ${t} conversion failed with code: ${o}`))})}}})}const M={setDefaultIpcMain(){$.handle("save-data",async(r,s)=>{await D(s)})}},{dialog:A}=require("electron"),m=require("os"),E=require("../package.json").version,R=[{label:"设置",submenu:[{label:"快速重启",accelerator:"F5",role:"reload"},{label:"退出",accelerator:"CmdOrCtrl+F4",role:"close"}]},{label:"编辑",submenu:[{label:"撤销",accelerator:"CmdOrCtrl+Z",role:"undo"},{label:"重做",accelerator:"Shift+CmdOrCtrl+Z",role:"redo"},{label:"剪切",accelerator:"CmdOrCtrl+X",role:"cut"},{label:"复制",accelerator:"CmdOrCtrl+C",role:"copy"},{label:"粘贴",accelerator:"CmdOrCtrl+V",role:"paste"}]},{label:"帮助",submenu:[{label:"关于",click:()=>{V()}}]}];function V(){A.showMessageBox({title:"关于",type:"info",message:"庭审系统录制软件",detail:`版本信息：${E}
引擎版本：${process.versions.v8}
当前系统：${m.type()} ${m.arch()} ${m.release()}`,noLink:!0})}const{app:n,BrowserWindow:O,systemPreferences:f,Menu:S}=require("electron"),c=require("path");process.env.DIST=c.join(__dirname,"../dist");process.env.PUBLIC=n.isPackaged?process.env.DIST:c.join(process.env.DIST,"../public");let e;const C=process.env.VITE_DEV_SERVER_URL;M.setDefaultIpcMain();function T(){e=new O({width:1280,height:780,icon:c.join(process.env.PUBLIC,"vite.svg"),webPreferences:{plugins:!0,contextIsolation:!1,nodeIntegration:!0,webSecurity:!1,enableRemoteModule:!0,devTools:!0}});const r=S.buildFromTemplate(R);S.setApplicationMenu(r),e.webContents.once("dom-ready",()=>{process.platform==="darwin"&&f.getMediaAccessStatus("microphone")!=="granted"&&(f.askForMediaAccess("microphone"),f.askForMediaAccess("camera"))}),e.webContents.on("did-finish-load",()=>{e==null||e.webContents.send("main-process-message",new Date().toLocaleString())}),process.env.NODE_ENV=="development"&&e.webContents.openDevTools(),C?e.loadURL(C):e.loadFile(c.join(process.env.DIST,"index.html")),require("@electron/remote/main").initialize(),require("@electron/remote/main").enable(e.webContents)}n.on("window-all-closed",()=>{e=null,n.quit()});n.whenReady().then(()=>{T()});n.commandLine.appendSwitch("disable-features","OutOfBlinkCors");n.commandLine.appendArgument("no-sandbox");n.commandLine.appendArgument("disable-setuid-sandbox");n.commandLine.appendArgument("disable-web-security");n.commandLine.appendArgument("ignore-certificate-errors");n.commandLine.appendSwitch("disable-site-isolation-trials");n.commandLine.appendSwitch("enable-quic");
